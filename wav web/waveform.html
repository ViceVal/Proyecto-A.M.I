<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Waveform WebAudio ‚Äî Zoom, Reproducci√≥n, Cargar WAV</title>
    <style>
        body {
            background: #0f1720;
            color: #e6eef6;
            font-family: Arial;
            text-align: center;
            padding: 20px;
        }
        canvas {
            border: 1px solid #334;
            background:#0b1520;
            border-radius:8px;
            width: 95%;
            max-width: 1300px;
            height: 400px;
            margin-top: 20px;
            cursor: crosshair;
        }
        button, input[type="file"] {
            margin: 6px;
            padding: 10px 16px;
            background:#1a2a3b;
            border:1px solid #445;
            color:white;
            border-radius:8px;
            cursor:pointer;
        }
        button:disabled {
            opacity:0.4;
            cursor:not-allowed;
        }
        .infoBox {
            background:#13202c;
            padding:10px;
            border-radius:8px;
            display:inline-block;
            margin:6px;
            min-width:180px;
        }
        .label { color:#9fb3bf; font-size:12px; }
        .value { font-size:16px; font-weight:bold; color:#e7ffee; }
    </style>
</head>
<body>

<h1>Waveform Viewer ‚Äî WebAudio</h1>

<input type="file" id="fileInput" accept=".wav" />

<div>
    <button id="playBtn" disabled>‚ñ∂ Play</button>
    <button id="pauseBtn" disabled>‚è∏ Pausa</button>
    <button id="zoomAllBtn" disabled>üîç Zoom todo</button>
</div>

<canvas id="waveCanvas"></canvas>

<div class="infoBox">
    <div class="label">Posici√≥n cursor</div>
    <div class="value" id="cursorTime">‚Äî</div>
</div>
<div class="infoBox">
    <div class="label">Amplitud</div>
    <div class="value" id="cursorAmp">‚Äî</div>
</div>
<div class="infoBox">
    <div class="label">Playhead</div>
    <div class="value" id="playTime">‚Äî</div>
</div>
<div class="infoBox">
    <div class="label">Duraci√≥n total</div>
    <div class="value" id="totalTime">‚Äî</div>
</div>

<script>
/* ==============================
   Variables generales
================================*/
let audioCtx = null;
let audioBuffer = null;
let sourceNode = null;
let isPlaying = false;
let playOffset = 0;
let playStartAt = 0;

let samples = null;
let sampleRate = 44100;
let TOTAL_SECONDS = 0;

let viewStart = 0;
let viewDuration = 15;
let minDuration = 0.05;

/* Canvas */
const canvas = document.getElementById("waveCanvas");
const ctx = canvas.getContext("2d");

/* Controles */
const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const zoomAllBtn = document.getElementById("zoomAllBtn");

/* Lecturas UI */
const cursorTimeEl = document.getElementById("cursorTime");
const cursorAmpEl = document.getElementById("cursorAmp");
const playTimeEl = document.getElementById("playTime");
const totalTimeEl = document.getElementById("totalTime");

/* ===========================================================
   Cargar WAV ‚Äî CORREGIDO PARA DETENER AUDIO ANTERIOR
=========================================================== */
document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if (!file) return;

    /* üî• DETENER AUDIO ANTERIOR */
    if (sourceNode) {
        try { sourceNode.stop(); } catch(_) {}
        try { sourceNode.disconnect(); } catch(_) {}
        sourceNode = null;
    }
    if (audioCtx) {
        try { audioCtx.close(); } catch(_) {}
    }

    isPlaying = false;
    playOffset = 0;
    playBtn.disabled = false;
    pauseBtn.disabled = true;

    /* üî• Crear nuevo AudioContext */
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    /* Cargar el nuevo WAV */
    const arrayBuffer = await file.arrayBuffer();
    audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    samples = audioBuffer.getChannelData(0);
    sampleRate = audioBuffer.sampleRate;
    TOTAL_SECONDS = samples.length / sampleRate;

    totalTimeEl.textContent = TOTAL_SECONDS.toFixed(2) + " s";

    viewStart = 0;
    viewDuration = Math.min(15, TOTAL_SECONDS);

    playBtn.disabled = false;
    zoomAllBtn.disabled = false;

    draw();
});

/* ===============================================================
   Reproducci√≥n
=============================================================== */
function playAudio(){
    if (!audioBuffer) return;

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.connect(audioCtx.destination);

    sourceNode.start(0, playOffset);
    playStartAt = audioCtx.currentTime - playOffset;

    isPlaying = true;
    playBtn.disabled = true;
    pauseBtn.disabled = false;
}

function pauseAudio(){
    if (!isPlaying) return;

    sourceNode.stop();
    playOffset = audioCtx.currentTime - playStartAt;

    isPlaying = false;
    playBtn.disabled = false;
    pauseBtn.disabled = true;
}

playBtn.onclick = playAudio;
pauseBtn.onclick = pauseAudio;

/* ===============================================================
   Dibujar waveform
=============================================================== */
function draw(){
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    const W = canvas.width, H = canvas.height, mid = H/2;

    ctx.fillStyle="#0b1520";
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle="#445";
    ctx.beginPath();
    ctx.moveTo(0, mid);
    ctx.lineTo(W, mid);
    ctx.stroke();

    ctx.strokeStyle="#00ffaa";
    ctx.lineWidth = 1.2;
    ctx.beginPath();

    const maxIndex = samples.length - 1;
    const AMP_BOOST = 4;

    for (let px=0; px<W; px++){
        const t = viewStart + (px/W)*viewDuration;
        const i = Math.floor(t * sampleRate);
        if (i < 0 || i > maxIndex) continue;

        const amp = samples[i] * AMP_BOOST;
        const y = mid - amp * (mid*0.9);

        if (px === 0) ctx.moveTo(px, y);
        else ctx.lineTo(px, y);
    }
    ctx.stroke();
}

/* ===============================================================
   Playhead animaci√≥n
=============================================================== */
function drawPlayhead(){
    if (isPlaying){
        const cur = audioCtx.currentTime - playStartAt;
        playTimeEl.textContent = cur.toFixed(2)+" s";

        if (cur >= TOTAL_SECONDS){
            pauseAudio();
            playOffset = 0;
        }

        draw();

        const W = canvas.width;
        const x = ((cur - viewStart) / viewDuration) * W;

        if (x >= 0 && x <= W){
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x,0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
    }
    requestAnimationFrame(drawPlayhead);
}
drawPlayhead();

/* ===============================================================
   Zoom (rueda del mouse)
=============================================================== */
canvas.addEventListener("wheel", (e)=>{
    if (!samples) return;
    e.preventDefault();

    const oldDur = viewDuration;
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;

    viewDuration *= (e.deltaY < 0 ? 0.9 : 1.1);
    viewDuration = Math.max(minDuration, Math.min(viewDuration, TOTAL_SECONDS));

    const mouseTime = viewStart + (mouseX/canvas.width)*oldDur;
    viewStart = mouseTime - (mouseX/canvas.width)*viewDuration;

    if (viewStart < 0) viewStart = 0;
    if (viewStart + viewDuration > TOTAL_SECONDS)
        viewStart = TOTAL_SECONDS - viewDuration;

    draw();
});

/* ===============================================================
   Arrastrar para desplazamiento
=============================================================== */
let dragging = false;

canvas.addEventListener("mousedown", ()=> dragging = true);
window.addEventListener("mouseup", ()=> dragging = false);

canvas.addEventListener("mousemove", (e)=>{
    if (!samples) return;

    if (dragging && e.buttons === 1){
        viewStart -= (e.movementX / canvas.width) * viewDuration;
        viewStart = Math.max(0, Math.min(viewStart, TOTAL_SECONDS - viewDuration));
        draw();
    }

    updateCursor(e);
});

/* ===============================================================
   Clic para saltar
=============================================================== */
canvas.addEventListener("click", (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;

    const t = viewStart + (x / canvas.width) * viewDuration;
    playOffset = Math.max(0, Math.min(t, TOTAL_SECONDS));

    if (isPlaying){
        sourceNode.stop();
        playAudio();
    } else {
        draw();
    }
});

/* ===============================================================
   Medir amplitud y tiempo bajo cursor
=============================================================== */
function updateCursor(e){
    if (!samples) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;

    const t = viewStart + (x / canvas.width) * viewDuration;
    const idx = Math.floor(t * sampleRate);

    cursorTimeEl.textContent = t.toFixed(3)+" s";

    if (idx < 0 || idx >= samples.length){
        cursorAmpEl.textContent = "‚Äî";
        return;
    }

    cursorAmpEl.textContent = samples[idx].toFixed(4);
}

/* ===============================================================
   Zoom a todo
=============================================================== */
zoomAllBtn.onclick = ()=>{
    viewStart = 0;
    viewDuration = TOTAL_SECONDS;
    draw();
};

/* Inicial */
draw();
</script>
</body>
</html>
