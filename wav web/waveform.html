<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Waveform WebAudio — Zoom, Play, Amplitud, Cargar WAV</title>
    <style>
        body {
            background: #0f1720;
            color: #e6eef6;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 18px;
        }

        #waveCanvas {
            border: 1px solid #334;
            background:#0b1520;
            border-radius:8px;
            width: 95%;
            max-width: 1300px;
            height: 400px;
            margin-top: 12px;
            cursor: crosshair;
        }

        .controls button, #fileInput {
            margin: 6px;
            padding: 8px 14px;
            background:#1a2a3b;
            border:1px solid #445;
            color:white;
            border-radius:8px;
            cursor:pointer;
        }

        .controls button:disabled {
            opacity:0.4;
            cursor:not-allowed;
        }

        .infoBox {
            margin-top: 10px;
            background:#13202c;
            padding:10px;
            display:inline-block;
            border-radius:8px;
            min-width:180px;
        }
        .label { color:#9fb3bf; font-size:12px; }
        .value { font-size:16px; font-weight:bold; color:#e7ffee; }
    </style>
</head>
<body>

<h1>Waveform — WebAudio Edition</h1>
<p>Selecciona un archivo WAV para analizar.</p>

<!-- SELECT WAV -->
<input type="file" id="fileInput" accept=".wav" />

<div class="controls">
    <button id="playBtn" disabled>Play</button>
    <button id="pauseBtn" disabled>Pausar</button>
    <button id="zoomAllBtn" disabled>Zoom todo</button>
</div>

<canvas id="waveCanvas"></canvas>

<div class="infoBox">
    <div class="label">Tiempo (cursor)</div>
    <div class="value" id="cursorTime">— s</div>
</div>

<div class="infoBox">
    <div class="label">Amplitud</div>
    <div class="value" id="cursorAmp">—</div>
</div>

<div class="infoBox">
    <div class="label">Playhead</div>
    <div class="value" id="playTime">— s</div>
</div>

<div class="infoBox">
    <div class="label">Duración WAV</div>
    <div class="value" id="totalTime">— s</div>
</div>

<script>
/* =====================================================
   VARIABLES
===================================================== */
let audioCtx = null;
let audioBuffer = null;
let samples = null;
let sampleRate = null;
let TOTAL_SECONDS = 0;

let sourceNode = null;
let isPlaying = false;
let playStartAt = 0;
let playOffset = 0;

let viewStart = 0;
let viewDuration = 15;
let minDuration = 0.05;

const canvas = document.getElementById('waveCanvas');
const ctx = canvas.getContext('2d');

const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const zoomAllBtn = document.getElementById('zoomAllBtn');

const cursorTimeEl = document.getElementById('cursorTime');
const cursorAmpEl  = document.getElementById('cursorAmp');
const playTimeEl   = document.getElementById('playTime');
const totalTimeEl  = document.getElementById('totalTime');

/* =====================================================
   CARGAR WAV DESDE BOTÓN
===================================================== */
document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if (!file) return;

    if (!audioCtx)
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const arrayBuffer = await file.arrayBuffer();
    audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    // usamos canal 0
    samples = audioBuffer.getChannelData(0);
    sampleRate = audioBuffer.sampleRate;
    TOTAL_SECONDS = samples.length / sampleRate;

    totalTimeEl.textContent = TOTAL_SECONDS.toFixed(3) + " s";

    // habilitar botones
    playBtn.disabled = false;
    zoomAllBtn.disabled = false;

    // ajustar viewport al inicio
    viewStart = 0;
    viewDuration = Math.min(15, TOTAL_SECONDS);

    draw();
});

/* =====================================================
   REPRODUCCIÓN
===================================================== */
function playAudio(){
    if (!audioBuffer) return;

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.connect(audioCtx.destination);

    sourceNode.start(0, playOffset);
    playStartAt = audioCtx.currentTime - playOffset;

    isPlaying = true;
    playBtn.disabled = true;
    pauseBtn.disabled = false;
}

function pauseAudio(){
    if (!isPlaying) return;

    sourceNode.stop();
    playOffset = audioCtx.currentTime - playStartAt;

    isPlaying = false;
    playBtn.disabled = false;
    pauseBtn.disabled = true;
}

playBtn.onclick = playAudio;
pauseBtn.onclick = pauseAudio;

/* =====================================================
   DRAW WAVEFORM
===================================================== */
function draw(){
    if (!samples) return;

    canvas.width  = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    const W = canvas.width, H = canvas.height;
    const mid = H/2;

    ctx.fillStyle="#0b1520";
    ctx.fillRect(0,0,W,H);

    // línea central
    ctx.strokeStyle="#334";
    ctx.beginPath();
    ctx.moveTo(0, mid);
    ctx.lineTo(W, mid);
    ctx.stroke();

    // time grid
    ctx.fillStyle="#8fb3c4";
    ctx.font="12px Arial";

    const step = getTimeStep(viewDuration);
    for (let t = Math.floor(viewStart); t < viewStart + viewDuration; t += step){
        const x = ((t - viewStart) / viewDuration) * W;

        ctx.strokeStyle="#223";
        ctx.beginPath();
        ctx.moveTo(x, H-10);
        ctx.lineTo(x, H);
        ctx.stroke();

        ctx.fillText(t.toFixed(1)+"s", x+4, H-14);
    }

    // waveform
    ctx.strokeStyle = "#00d084";
    ctx.lineWidth = 1.3;
    ctx.beginPath();

    const MAX = samples.length - 1;
    const AMP_BOOST = 4;

    for (let px = 0; px < W; px++){
        const t = viewStart + (px / W) * viewDuration;
        const idx = Math.floor(t * sampleRate);

        if (idx < 0 || idx > MAX) continue;

        const amp = samples[idx] * AMP_BOOST;
        const y = mid - amp * (mid * 0.95);

        if (px === 0) ctx.moveTo(px,y);
        else ctx.lineTo(px,y);
    }

    ctx.stroke();
}

/* =====================================================
   PLAYHEAD
===================================================== */
function drawPlayhead(){
    if (!isPlaying){
        playTimeEl.textContent = playOffset.toFixed(3)+" s";
        requestAnimationFrame(drawPlayhead);
        return;
    }

    const current = audioCtx.currentTime - playStartAt;
    playTimeEl.textContent = current.toFixed(3)+" s";

    if (current >= TOTAL_SECONDS){
        pauseAudio();
        playOffset = 0;
        requestAnimationFrame(drawPlayhead);
        return;
    }

    // autoscroll si playhead sale de vista
    if (current < viewStart || current > viewStart + viewDuration){
        viewStart = Math.max(0, current - viewDuration/2);
        draw();
    } else {
        draw();
    }

    // dibujar línea de playhead
    const W = canvas.width;
    const x = ((current - viewStart) / viewDuration) * W;

    if (x >= 0 && x <= W){
        ctx.strokeStyle="rgba(255,90,90,0.95)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,canvas.height);
        ctx.stroke();
    }

    requestAnimationFrame(drawPlayhead);
}

requestAnimationFrame(drawPlayhead);

/* =====================================================
   ZOOM
===================================================== */
canvas.addEventListener("wheel", (e)=>{
    if (!samples) return;

    e.preventDefault();

    const oldDur = viewDuration;
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;

    if (e.deltaY < 0) viewDuration *= 0.9;
    else viewDuration *= 1.1;

    viewDuration = Math.max(minDuration, Math.min(viewDuration, TOTAL_SECONDS));

    const mouseTime = viewStart + (mouseX / canvas.width) * oldDur;
    viewStart = mouseTime - (mouseX / canvas.width) * viewDuration;

    if (viewStart < 0) viewStart = 0;
    if (viewStart + viewDuration > TOTAL_SECONDS)
        viewStart = TOTAL_SECONDS - viewDuration;

    draw();
});

/* =====================================================
   DRAG (pan)
===================================================== */
let dragging = false;
canvas.addEventListener("mousedown", ()=> dragging = true);
window.addEventListener("mouseup", ()=> dragging = false);

canvas.addEventListener("mousemove", (e)=>{
    if (!samples) return;

    if (dragging && e.buttons === 1){
        const dx = e.movementX;
        viewStart -= (dx / canvas.width) * viewDuration;
        viewStart = Math.max(0, Math.min(viewStart, TOTAL_SECONDS - viewDuration));
        draw();
    }

    updateCursorReadout(e);
});

/* =====================================================
   CLICK → SEEK
===================================================== */
canvas.addEventListener("click", (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;

    const t = viewStart + (x / canvas.width) * viewDuration;

    playOffset = Math.max(0, Math.min(t, TOTAL_SECONDS));

    if (isPlaying){
        sourceNode.stop();
        playAudio();
    } else {
        draw();
    }

    updateCursorReadout(e);
});

/* =====================================================
   LECTURA DE AMPLITUD INSTANTÁNEA
===================================================== */
function updateCursorReadout(e){
    if (!samples) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (x < 0 || x > canvas.width || y < 0 || y > canvas.height){
        cursorTimeEl.textContent = "—";
        cursorAmpEl.textContent  = "—";
        return;
    }

    const t = viewStart + (x / canvas.width) * viewDuration;
    const idx = Math.floor(t * sampleRate);

    cursorTimeEl.textContent = t.toFixed(3)+" s";

    if (idx < 0 || idx >= samples.length){
        cursorAmpEl.textContent = "—";
        return;
    }

    cursorAmpEl.textContent = samples[idx].toFixed(4);
}

/* =====================================================
   BOTÓN ZOOM A TODO
===================================================== */
zoomAllBtn.onclick = ()=>{
    viewStart = 0;
    viewDuration = TOTAL_SECONDS;
    draw();
};

/* =====================================================
   TIME GRID HELP
===================================================== */
function getTimeStep(span){
    if (span <= 0.5) return 0.05;
    if (span <= 1) return 0.1;
    if (span <= 3) return 0.2;
    if (span <= 6) return 0.5;
    if (span <= 15) return 1;
    if (span <= 30) return 2;
    if (span <= 60) return 5;
    if (span <= 120) return 10;
    return 30;
}
</script>
</body>
</html>
